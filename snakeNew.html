<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>مار بازی با غذا</title>
    <link rel="stylesheet" href="src/styles/app.css">
</head>

<body id="background">

    <div id="div1">
        <!-- سر مار با چشم‌ها -->
        <div id="div2">
            <div class="div3">
                <div class="div4"></div>
            </div>
            <div class="div3">
                <div class="div4"></div>
            </div>
        </div>
        <!-- غذا -->
        <div id="food">
            <div class="food-barg"></div>
        </div>
    </div>

    <div class="wrapper">
        <button class="btnrun" onclick="startMove()">شروع</button>
        <span id="score">امتیاز: 0</span>
    </div>

    <script>
        var timer;
        var dir = "";
        var score = 0;
        var snakeParts = []; // آرایه بدن مار

        const div2 = document.getElementById("div2"); // سر مار
        const div1 = document.getElementById("div1");
        const food = document.getElementById("food");
        const scoreDisplay = document.getElementById("score");

        // اضافه کردن سر مار به آرایه
        snakeParts.push(div2);

        document.onkeydown = function (e) {
            e = e || window.event;
            if (e.keyCode == 37) dir = "left";
            else if (e.keyCode == 38) dir = "up";
            else if (e.keyCode == 39) dir = "right";
            else if (e.keyCode == 40) dir = "down";
        };

        function startMove() {
            clearInterval(timer); // پاک کردن تایمر قبلی
            dir = "right";        // جهت اولیه
            score = 0;            // امتیاز صفر
            scoreDisplay.innerText = "امتیاز: " + score;

            // پاک کردن همه‌ی بخش‌های بدن قبلی
            snakeParts.forEach(part => {
                if (part !== div2) {
                    part.remove();
                }
            });
            // ریست کردن سر مار
            div2.style.left = "0px";
            div2.style.top = "0px";

            // آرایه بدن فقط شامل سر مار باشه
            snakeParts = [div2];

            placeFood();
            timer = setInterval(moveDiv, 30);
        }


        function placeFood() {
            const canvas_w = parseInt(getComputedStyle(div1).width);
            const canvas_h = parseInt(getComputedStyle(div1).height);
            const foodSize = parseInt(getComputedStyle(food).width);

            const maxLeft = canvas_w - foodSize;
            const maxTop = canvas_h - foodSize;

            // غذا روی شبکه‌ی 5px قرار می‌گیرد
            const randomLeft = Math.floor(Math.random() * (maxLeft / 5)) * 5;
            const randomTop = Math.floor(Math.random() * (maxTop / 5)) * 5;

            food.style.left = randomLeft + "px";
            food.style.top = randomTop + "px";
        }

        function moveDiv() {
            const head = snakeParts[0];
            const snake_left = parseInt(getComputedStyle(head).left);
            const snake_top = parseInt(getComputedStyle(head).top);
            const canvas_w = parseInt(getComputedStyle(div1).width);
            const canvas_h = parseInt(getComputedStyle(div1).height);
            const snake_w = parseInt(getComputedStyle(head).width);
            var step = 5; // حرکت نرم‌تر

            // برخورد با دیوار
            if (
                (dir == "up" && snake_top - step < 0) ||
                (dir == "down" && snake_top + step > canvas_h - snake_w) ||
                (dir == "left" && snake_left - step < 0) ||
                (dir == "right" && snake_left + step > canvas_w - snake_w)
            ) {
                background.style.background = "#fff";
                clearInterval(timer);
                alert("باختی!");
                return;
            }

            // حرکت بدن: هر بخش جای قبلی بخش قبل رو می‌گیره
            for (let i = snakeParts.length - 1; i > 0; i--) {
                snakeParts[i].style.left = snakeParts[i - 1].style.left;
                snakeParts[i].style.top = snakeParts[i - 1].style.top;
            }

            // حرکت سر
            if (dir == "up") {
                head.style.top = (snake_top - step) + "px";
            } else if (dir == "down") {
                head.style.top = (snake_top + step) + "px";
            } else if (dir == "left") {
                head.style.left = (snake_left - step) + "px";
            } else if (dir == "right") {
                head.style.left = (snake_left + step) + "px";
            }

            const food_left = parseInt(getComputedStyle(food).left);
            const food_top = parseInt(getComputedStyle(food).top);
            const food_w = parseInt(getComputedStyle(food).width);
            const food_h = parseInt(getComputedStyle(food).height);

            // بررسی برخورد با غذا
            if (
                snake_left < food_left + food_w &&
                snake_left + snake_w > food_left &&
                snake_top < food_top + food_h &&
                snake_top + snake_w > food_top
            ) {
                score++;
                scoreDisplay.innerText = "امتیاز: " + score;
                placeFood();

                // اضافه کردن بخش جدید به بدن مار
                const newPart = document.createElement("div");
                newPart.style.width = "30px";
                newPart.style.height = "30px";
                newPart.style.backgroundColor = "#FF9800";
                newPart.style.position = "absolute";
                newPart.style.borderRadius = "8px";
                newPart.style.border = "1px solid #FFFF00";
                newPart.style.zIndex = "4";

                // قرار گرفتن بخش جدید در جای آخرین بخش بدن
                const last = snakeParts[snakeParts.length - 1];
                newPart.style.left = last.style.left;
                newPart.style.top = last.style.top;


                // appendChild یک متد جاوااسکریپت برای اضافه کردن یک المان جدید به داخل یک المان والد (Parent) هست. یعنی وقتی یک div یا هر عنصر HTML جدید می‌سازی، با appendChild می‌تونی اون رو بذاری داخل یک عنصر دیگه.
                div1.appendChild(newPart);
                snakeParts.push(newPart);

                // افزایش سرعت
                if (score === 2) {
                    changeSpeed(25, "#FF7043");
                } else if (score === 5) {
                    changeSpeed(20, "#E91E63");
                } else if (score === 8) {
                    changeSpeed(15, "#880E4F");
                }
            }
        }

        function changeSpeed(newSpeed, newColor) {
            clearInterval(timer);
            background.style.background = newColor;
            timer = setInterval(moveDiv, newSpeed);
        }

    </script>

</body>

</html>